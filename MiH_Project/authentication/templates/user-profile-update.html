{% extends 'master.html' %}

{% block title %}Edit Profile | {{user.name}} {% endblock %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'profile-edit-style.css' %}">
{% endblock %}

{% block content %}

<body data-update-success="{% if messages %}{% for message in messages %}{% if message.tags == 'success' %}true{% endif %}{% endfor %}{% endif %}">
<div class="edit-wrapper">
    <form action="{% url 'update_profile' id=user.id %}"
          method="post"
          enctype="multipart/form-data">

        {% csrf_token %}

        {% if user.profile_pic %}
        <img src="{{ user.profile_pic.url}}"
             class="profile-img"
             alt="Profile Picture">
        {% else %}
        <img src="{% static 'assets/default-profile.png' %}"
             class="profile-img"
             alt="Default Profile">
        {% endif %}

        <!-- Upload new image -->
        <div class="mb-3 text-center" >
            <input type="file"
                   name="profile_pic"
                   class="form-control w-50 h-100 mx-auto">
        </div>

        <div class="edite-group">
            <label>Name</label>
            <div class="name-box">
                <input type="text"
                       name="name"
                       value="{{ user.name }}"></div>
            <span class="text-danger">
                    {{ form.name.errors }}
            </span>
            <label>Email</label>
            <div class="email-box">
                <input type="email"
                       name="email"
                       disabled
                       value="{{ user.email }}">
            </div>

            <label>Phone Number</label>
            <div class="phone-box">
                <input type="text"
                       name="phone"
                       value="{{ form.phone.value|default:user.phone }}"
                       class="form-control"
                       inputmode="numeric">
            </div>
            <span class="text-danger">
                    {{ form.phone.errors }}
            </span>
            <label>Address</label>
            <div class="address-box">
                <input type="text"
                       name="address"
                       value="{{ user.address }}"></div>
            <span class="text-danger">
                    {{ form.address.errors }}
            </span>
            <div class="buttons">
                <button type="submit" class="btn btn-change">
                    Update
                </button>
                <button type="button"
                        class="btn btn-cancel"
                        id="cancelBtn">
                    Cancel
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <img src="{% static 'assets/success-icon.png'%}" class="modal-icon" alt="success">
        <h3 class="modal-title">Success!</h3>
        <p class="modal-text">Your profile is successfully updated.</p>
        <button id="modalBackBtn">Back</button>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const modal = document.getElementById("successModal");
    const modalBackBtn = document.getElementById("modalBackBtn");

    // Check if success flag is set
    const isSuccess = document.body.dataset.updateSuccess === "true";
    if (isSuccess) {
        modal.style.display = "flex";
    }

    modalBackBtn.addEventListener("click", function () {
        window.location.href = "{% url 'profile_page' %}";
    });

    // Close modal when clicking outside
    window.addEventListener("click", function (event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });

    // Cancel button goes back
    const cancelBtn = document.getElementById("cancelBtn");
    cancelBtn.addEventListener("click", function () {
        window.location.href = "{% url 'profile_page' %}";
    });
</script>
{% endblock %}