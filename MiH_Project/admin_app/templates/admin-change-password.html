{% extends 'dashboard.html' %}

{% block title %}Change Password | {{user.name}}{% endblock %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'pw-style.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <h2>Change Password</h2>
    <p class="subtitle">
        Enter and confirm your new password to regain access
    </p>

    <form method="POST" action="{% url 'change_password' %}">
        {% csrf_token %}
        <div class="form-group">
            <label>Old Password</label>
            <div class="password-box">
                <input type="password" class="form-control {% if form.old_password.errors %}is-invalid{% endif %}"
                       name="old_password" placeholder="Enter old password">
                <div class="invalid-feedback">
                    {% for error in form.old_password.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>New Password</label>
            <div class="password-box">
                <input type="password" class="form-control {% if form.new_password.errors %}is-invalid{% endif %}"
                       name="new_password" placeholder="Enter new password">
                <div class="invalid-feedback">
                    {% for error in form.new_password.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Confirm Password</label>
            <div class="password-box">
                <input type="password"
                       class="form-control {% if form.confirm_password.errors %}is-invalid{% endif %}"
                       name="confirm_password" placeholder="Confirm new password">
                <div class="invalid-feedback">
                    {% for error in form.confirm_password.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
            </div>
        </div>

        {% if messages %}
        {% for message in messages %}
        <div class="alert
        {% if message.tags == 'error' %}alert-danger
        {% elif message.tags == 'success' %}alert-success
        {% else %}alert-info{% endif %}"
             role="alert">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <div class="d-flex justify-content-center gap-2 mt-4">
            <button type="submit" class="btn btn-primary">Change</button>
            <a href="javascript:history.back()" class="btn btn-secondary" id="cancelBtn">Cancel</a>
        </div>
    </form>

    <!-- Popup Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <img src="{% static 'assets/success-icon.png' %}" alt="Success Icon" class="modal-icon">
            <h3 class="modal-title">Success!</h3>
            <p class="modal-text">Your password is successfully changed.</p>
            <button id="modalBackBtn" class="btn btn-primary">Back</button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const modal = document.getElementById("successModal");
    const modalBackBtn = document.getElementById("modalBackBtn");

    // Check if success flag is set
    const isSuccess = document.body.dataset.updateSuccess === "true";
    if (isSuccess) {
        modal.style.display = "flex";
    }

    modalBackBtn.addEventListener("click", function () {
        window.location.href = "{% url 'profile_page' %}";
    });

    // Close modal when clicking outside
    window.addEventListener("click", function (event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });

    // Cancel button goes back
    const cancelBtn = document.getElementById("cancelBtn");
    cancelBtn.addEventListener("click", function () {
        window.location.href = "{% url 'profile_page' %}";
    });
</script>
{% endblock %}